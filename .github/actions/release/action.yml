name: release
description: "release"
inputs:
  tag:
    description: |
      The tags to release images with.
    required: true
  extraTags:
    description: |
      The extra tags to release images with.
    required: false
  archs:
    description: |
      The architectures to release images with.
    default: x86_64 #,aarch64
runs:
  using: composite
  steps:
    - name: Populate workspace with source only
      shell: bash
      run: |
        shopt -s dotglob && tmp="$(mktemp -d)" && \
          mv melange.rsa.pub pipelines ${{ inputs.tag }}/* ${tmp}/ && \
          mv .github ${tmp}/ && \
          rm -rf ./* && mv ${tmp}/* . && \
          echo ".github/" >> .melangeignore && tree -a . && \
          sudo rm -rf /work && sudo mkdir /work

    - name: Write melange key
      shell: bash
      run: |
        printf '%s' "$MELANGE_PRIVATE_KEY" > melange.rsa
        chmod 0600 melange.rsa

    - uses: eminaktas/actions/melange-build@feat/sign-own-key
      with:
        archs: ${{ inputs.archs }}
        multi-config: keycloak-melange.yaml,keycloak-metrics-spi-melange.yaml
        sign-with-own-key: true
        signing-key-path: melange.rsa
        repository-path: /work/packages
        pipeline-dir: pipelines

    - name: Create temp copy of /work directory (used in next step)
      shell: bash
      run: |
        rm -rf .apko-automount && cp -r /work .apko-automount

    - name: Set image name
      shell: bash
      id: image
      run: |
        # Start with the main tag
        ALL_TAGS="latest-${{ inputs.tag }}"

        # Append extraTags if provided
        if [ -n "${{ inputs.extraTags }}" ]; then
          ALL_TAGS="${ALL_TAGS},${{ inputs.extraTags }}"
        fi

        REPO="ghcr.io/${{ github.repository }}"
        IMAGE_TAGS=""

        IFS=',' read -ra TAG_ARRAY <<< "$ALL_TAGS"
        for tag in "${TAG_ARRAY[@]}"; do
          tag=$(echo "$tag" | xargs)  # Trim whitespace
          IMAGE_TAGS="${IMAGE_TAGS} ${REPO}:${tag}"
        done

        IMAGE_TAGS=$(echo "$IMAGE_TAGS" | xargs)  # Trim leading/trailing whitespace
        echo "IMAGE=${IMAGE_TAGS}" >> $GITHUB_OUTPUT

    - name: Generate snapshot date
      id: snapshot-date
      run: |
        echo ::set-output name=date::$(date -u +%Y%m%d)
        echo ::set-output name=epoch::$(date -u +%s)
      shell: bash

    - uses: chainguard-images/actions/apko-publish@main
      with:
        archs: ${{ inputs.archs }}
        config: apko.yaml
        tag: ${{ steps.image.outputs.IMAGE }}
        keyring-append: melange.rsa.pub
        automount-src: .apko-automount/.
        automount-dest: /work
        source-date-epoch: ${{ steps.snapshot-date.outputs.epoch }}

    # - uses: sigstore/cosign-installer@main

    - name: Smoke test
      shell: bash
      run: |
        set -e

        # Use the first tag for smoke testing
        refs="${{ steps.image.outputs.IMAGE }}"
        ref=$(echo "$refs" | awk '{print $1}')

        docker pull "${ref}"

        # cosign verify "${ref}" --key melange.rsa.pub

        docker run -d --rm -p 9000:9000 -p 8080:8080 \
          -e KEYCLOAK_DATABASE_VENDOR=dev-mem \
          -e KEYCLOAK_ENABLE_HEALTH_ENDPOINTS=true \
          -e KC_BOOTSTRAP_ADMIN_PASSWORD=keycloak123 \
          --name smoketest "${ref}"

        trap "docker rm -f smoketest" EXIT
        sleep 30 # Give server a few seconds to come up

        curl -v --max-time 10 --fail http://localhost:9000/health
        curl -v --max-time 10 --fail http://localhost:8080/realms/master/metrics
