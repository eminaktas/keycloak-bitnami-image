package:
  name: keycloak-bitnami
  version: 26.0.14
  epoch: 0
  description: "Open Source Identity and Access Management For Modern Applications and Services"
  copyright:
    - paths:
        - "*"
      attestation: ""
      license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - merged-usrsbin
      - openjdk-21-default-jdk
      - wolfi-baselayout
  target-architecture:
    - x86_64
    # - aarch64

# Create a new major-version variable that contains only the major version
# to use in the bitnami/compat pipeline to find out the correct folder for the image.
# e.g. 25.0.2 will create a new var major-version=25
var-transforms:
  - from: ${{package.version}}
    match: ^(\d+).*
    replace: $1
    to: major-version

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - gcc-13-default
      - openjdk-21-default-jdk
      - wolfi-base
      - wolfi-baselayout
  environment:
    LANG: en_US.UTF-8
    JAVA_HOME: /usr/lib/jvm/java-21-openjdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/keycloak/keycloak
      tag: ${{package.version}}
      expected-commit: 64ed7c98cb97120af981b8427870d8c79ec89e4d

  # Ref: https://github.com/wolfi-dev/os/blob/146ac3433fcaed0dc663836ad71086e080ddf901/keycloak/pom.patch
  - uses: patch
    with:
      patches: pom.patch

  - uses: maven/pombump

  - runs: |
      gcc napi-static-assert.c -o /tmp/preload.so -fPIC -shared -ldl

  - runs: |
      # Build keycloak-server. Depends on `keycloak-js-adapter-jar`.
      # Gross hack to work around broken NAPI ast-grep module that has
      # undefined symbol: static_assert
      export LD_PRELOAD=/tmp/preload.so
      ./mvnw clean install --errors -DskipTests -DskipTestsuite -DskipExamples -q -DskipProtoLock=true
      unset LD_PRELOAD

      mkdir -p ${{targets.destdir}}/opt/bitnami
      unzip -d ${{targets.destdir}}/opt/bitnami quarkus/dist/target/keycloak-*.zip
      mv ${{targets.destdir}}/opt/bitnami/keycloak-* ${{targets.destdir}}/opt/bitnami/keycloak

subpackages:
  - name: ${{package.name}}-compat
    description: "compat package with bitnami/keycloak image"
    dependencies:
      runtime:
        - bash # Keycloak helper scripts require bash, aren't compatible with busybox.
        - coreutils # Keycloak Helm Chart scripts require coreutils, aren't compatible with busybox. (i.e., `cp` with `--preserve` option)
        - krb5
        - libaio
        - merged-usrsbin
        - net-tools
        - openjdk-21-default-jdk
        - posix-libc-utils
        - procps
        - su-exec
        - wait-for-port
        - wolfi-baselayout
        - zlib
    pipeline:
      - uses: bitnami/compat
        with:
          image: keycloak
          commit: a8bf7654f9ee9dfd20fb9073086995a36bbc26a7
          version-path: ${{vars.major-version}}/debian-12
      - runs: |
          mkdir -p ${{targets.contextdir}}/bitnami/keycloak
          mkdir -p ${{targets.contextdir}}/opt/bitnami/keycloak
          mkdir -p ${{targets.contextdir}}/docker-entrypoint-initdb.d

          for dir in bin conf conf.default lib providers themes; do
            mkdir -p ${{targets.contextdir}}/opt/bitnami/keycloak/$dir
          done

          chmod g+rwX ${{targets.contextdir}}/opt/bitnami

          # Change the flag for hostname command in the script otherwise, it fails by saying unknown flag for --fqdn
          sed -i 's/hostname --fqdn/hostname -f/g' ${{targets.contextdir}}/opt/bitnami/scripts/keycloak-env.sh

          # Fix the JAVA_HOME Path in the script
          sed -i 's/JAVA_HOME="\/opt\/bitnami\/java"/JAVA_HOME="\/usr\/lib\/jvm\/java-21-openjdk"/g' ${{targets.contextdir}}/opt/bitnami/scripts/keycloak-env.sh

          # Change the path for java security folder in the script
          sed -i 's/\/opt\/bitnami\/java\/lib\/security/\/usr\/lib\/jvm\/java-21-openjdk\/conf\/security/g' ${{targets.contextdir}}/opt/bitnami/scripts/java/postunpack.sh

          # The `--userspec`` flag belongs to GNU's chroot, whereas we are use BusyBox's. As a workaround, use `su-exec` instead.
          sed -i 's|exec chroot --userspec="$userspec" /|exec chroot / su-exec "$userspec"|' ${{targets.contextdir}}/opt/bitnami/scripts/libos.sh
          sed -i 's|chroot --userspec="$userspec" /|chroot / su-exec "$userspec"|' ${{targets.contextdir}}/opt/bitnami/scripts/libos.sh

          # Disable some commands used in Bitnami scripts. These commands more likely fail in this since this image take non root approach
          sed -i 's/chown -R "$KEYCLOAK_DAEMON_USER" "$dir"/# chown -R "$KEYCLOAK_DAEMON_USER" "$dir"/g' ${{targets.contextdir}}/opt/bitnami/scripts/keycloak/postunpack.sh
          sed -i 's/ensure_user_exists/# ensure_user_exists/g' ${{targets.contextdir}}/opt/bitnami/scripts/keycloak/postunpack.sh
          sed -i 's/am_i_root/# am_i_root/g' ${{targets.contextdir}}/opt/bitnami/scripts/keycloak/setup.sh

          # Use package path while unpacking
          find . -iname "*.sh" -exec sed 's#/opt/bitnami#${{targets.contextdir}}/opt/bitnami#g' -i {} \;
            ${{targets.contextdir}}/opt/bitnami/scripts/keycloak/postunpack.sh || true
          # Restore path
          find ${{targets.contextdir}}/opt/bitnami -type f -exec sed 's#${{targets.contextdir}}##g' -i {} \;
